## WeSense MQTT Hub - EMQX Configuration
## See https://docs.emqx.com/en/emqx/latest/configuration/configuration.html

## =============================================================================
## Node
## =============================================================================
node {
  name = "wesense@127.0.0.1"
  cookie = "CHANGE_ME_GENERATE_A_RANDOM_STRING"
  data_dir = "/opt/emqx/data"
}

## =============================================================================
## Cluster (single node for now)
## =============================================================================
cluster {
  name = wesense
  discovery_strategy = manual
}

## =============================================================================
## Dashboard
## =============================================================================
dashboard {
  listeners.http {
    bind = 18083
  }
}

## =============================================================================
## MQTT Listeners
## =============================================================================

## Plain MQTT (consider disabling in production)
listeners.tcp.default {
  bind = "0.0.0.0:1883"
  max_connections = 1024000
}

## MQTT over TLS
## Controlled via .env: TLS_MQTT_ENABLED=true/false
## Certificate paths also set via .env
listeners.ssl.default {
  bind = "0.0.0.0:8883"
  max_connections = 1024000
  ssl_options {
    verify = verify_none
  }
}

## WebSocket (plain)
listeners.ws.default {
  bind = "0.0.0.0:8083"
  max_connections = 1024000
}

## WebSocket over TLS
## Controlled via .env: TLS_WS_ENABLED=true/false
## Certificate paths also set via .env
listeners.wss.default {
  bind = "0.0.0.0:8084"
  max_connections = 1024000
  ssl_options {
    verify = verify_none
  }
}

## =============================================================================
## Authentication
## =============================================================================

## Anonymous access enabled by default for easy setup.
## Clients can connect with or without credentials.
##
## To enable password authentication:
##   1. Start the stack: docker compose --profile station up -d
##   2. Open the EMQX dashboard: http://<host>:18083 (admin / public)
##   3. Go to Access Control > Authentication
##   4. Create a "Password-Based" authenticator with "Built-in Database"
##   5. Add users under Access Control > Authentication > Users
##   6. Comment out allow_anonymous below and uncomment the authentication block
##   7. Restart: docker compose --profile station restart emqx
##
allow_anonymous = true

## Uncomment to require password authentication:
# authentication = [
#   {
#     mechanism = password_based
#     backend = built_in_database
#     user_id_type = username
#     password_hash_algorithm {
#       name = bcrypt
#     }
#   }
# ]

## =============================================================================
## Authorization
## =============================================================================

## Default: allow all (for Phase 1)
## Restrict in production
authorization {
  no_match = allow
  deny_action = ignore
  cache {
    enable = true
    max_size = 32
    ttl = 1m
  }
}

## =============================================================================
## System Topics ($SYS)
## =============================================================================
sys_topics {
  sys_msg_interval = 1m
  sys_heartbeat_interval = 30s
}

## =============================================================================
## Logging
## =============================================================================
log {
  file {
    enable = true
    level = warning
    path = "/opt/emqx/log/emqx.log"
    rotation_size = 50MB
    rotation_count = 10
  }
  console {
    enable = true
    level = info
  }
}

## =============================================================================
## Prometheus Metrics
## =============================================================================
## EMQX exposes metrics at /api/v5/prometheus/stats by default
## Push gateway is disabled - use pull-based scraping instead
## To enable push gateway, uncomment and set a valid URL:
# prometheus {
#   push_gateway_server = "http://pushgateway:9091"
#   interval = 15s
# }
